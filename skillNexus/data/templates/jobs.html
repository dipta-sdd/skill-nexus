{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkilNexus</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="{%  static 'css/style.css' %}" />
  </head>

  <body>
    <div aria-live="polite" aria-atomic="true" class="position-relative">
      <div class="toast-container top-0 end-0 p-3">
        <!-- Then put toasts within -->
      </div>
    </div>
    {% include "sidebar.php" %}

    <div class="my-round" id="body">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mybg-t breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/" class="my-color">Home</a></li>
          <li class="breadcrumb-item active my-color" aria-current="page"></li>
        </ol>
      </nav>
      <!-- Program Print Section -->

      <!-- Modal -->
      <div
        class="modal fade modal-lg"
        id="modal1"
        tabindex="-1"
        aria-labelledby="programSessionModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <form id="">
              <div class="modal-header">
                <h5 class="modal-title" id=""></h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body"></div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button type="submit" class="btn btn-primary save">
                  Save changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!--  Overview Section -->
      <div class="row">
        <div class="col-lg-12">
          <div class="card my-row rounded-0 mybg">
            <div class="card-header" style="margin: -10px -10px 0 -10px">
              <div class="d-flex justify-content-between">
                <h3 class="card-title mb-0">Job Listings</h3>
              </div>
            </div>
            <div class="card-body m-0 p-0 bg-transparent">
              <div class="m-2">
                <div class="row">
                  <div class="mt-2 col-lg-6">
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Search jobs..."
                        name="search"
                        id="search"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        id="searchBtn"
                        type="submit"
                      >
                        Search
                      </button>
                    </div>
                  </div>
                  <div class="mt-2 col-lg-6 d-flex flex-row">
                    <div class="input-group me-5 mb-3" style="flex: 1">
                      <span class="input-group-text"
                        ><i class="fa-solid fa-filter"></i
                      ></span>
                      <select
                        class="form-control"
                        name="status"
                        id="status"
                        aria-label="Default select example"
                      >
                        <option selected value="">All</option>
                        <option value="open">Open</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed ">Completed</option>
                        <option value="cancelled">Cancelled</option>
                      </select>
                    </div>

                    <p class="">
                      <a
                        class="btn btn-primary"
                        data-bs-toggle="collapse"
                        href="#collapseExample"
                        role="button"
                        aria-expanded="false"
                        aria-controls="collapseExample"
                      >
                        Filter by Skill
                      </a>
                    </p>
                  </div>
                  <div class="collapse" id="collapseExample">
                    <div class="card card-body bg-transparent border-0">
                      <form method="GET" action="/jobs">
                        <div class="row" id="skills">
                          {% for skill in skills %}
                          <div
                            class="form-check col-xl-3 col-lg-4 col-sm-6"
                            id="skills"
                          >
                            <input
                              class="form-check-input"
                              type="checkbox"
                              name="skill"
                              value="{{ skill.id }}"
                            />
                            <label
                              class="form-check-label"
                              for="skill_{{ skill.id }}"
                            >
                              {{ skill.name }}
                            </label>
                          </div>
                          {% endfor %}
                        </div>
                        <button
                          type="submit"
                          class="btn btn-primary mt-2 apply"
                        >
                          Apply Filter
                        </button>
                      </form>
                    </div>
                  </div>
                </div>

                <div class="card-body m-0 p-0 bg-transparent">
                  <table class="table table-striped border">
                    <thead>
                      <tr id="sort">
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Title </span
                            ><i class="fa-solid fa-sort sort" name="title"></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Location </span
                            ><i
                              class="fa-solid fa-sort sort"
                              name="location"
                            ></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Duration </span
                            ><i
                              class="fa-solid fa-sort sort"
                              name="project_duration"
                            ></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Price </span
                            ><i class="fa-solid fa-sort sort" name="price"></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Deadline </span
                            ><i
                              class="fa-solid fa-sort sort"
                              name="deadline"
                            ></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Skills </span
                            ><i class="fa-solid fa-sort sort" name="skills"></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Created At </span
                            ><i
                              class="fa-solid fa-sort-up sort"
                              name="created_at"
                            ></i>
                          </div>
                        </th>
                        <th>
                          <div class="d-flex flex-nowrap">
                            <span class="me-2">Status</span>
                            <i class="fa-solid fa-sort sort" name="status"></i>
                          </div>
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for job in jobs %}
                      <tr>
                        <td>
                          <a
                            href="/job/{{ job.id }}"
                            class="text-decoration-none"
                            >{{ job.title }}</a
                          >
                        </td>
                        <td>{{ job.location }}</td>
                        <td>{{ job.project_duration }}</td>
                        <td>{{ job.price }}</td>
                        <td>{{ job.deadline }}</td>
                        <td>{{ job.skills }}</td>
                        <td>{{ job.created_at }}</td>
                        <td>
                          {% if job.status == 'open' %}
                          <span class="badge bg-info">Open</span>
                          {% elif job.status == 'in_progress' %}
                          <span class="badge bg-primary">In Progress</span>
                          {% elif job.status == 'completed' %}
                          <span class="badge bg-success">Completed</span>
                          {% elif job.status == 'cancelled' %}
                          <span class="badge bg-danger">Cancelled</span>
                          {% else %}
                          <span class="badge bg-secondary"
                            >{{ job.status }}</span
                          >
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script>
      $(document).ready(function () {
        on_page_load([]);

        // Add event listeners to sort icons
        $("#sort .sort").on("click", function () {
          // Get the column name to sort by
          var column = $(this).attr("name");

          // Get current sort order (if any)
          var currentOrder = $(this).hasClass("fa-sort-up")
            ? "ASC"
            : $(this).hasClass("fa-sort-down")
            ? "DESC"
            : "";

          // Determine new sort order
          var newOrder = currentOrder === "ASC" ? "DESC" : "ASC";

          // Update sort icons
          $("#sort .sort").removeClass("fa-sort-up fa-sort-down"); // Reset all icons
          $(this).addClass(
            "fa-" + (newOrder === "ASC" ? "sort-up" : "sort-down")
          );

          // Apply filters and sorting
          loadjobs();
        });
        function getFilters() {
          var status = $("#status").val();
          var skills = [];
          $("input[name='skill']:checked").each(function () {
            skills.push($(this).val());
          });
          var search = $("#search").val();
          var sortby = $("#sort .fa-sort-up, #sort .fa-sort-down")
            .parent()
            .find("i")
            .attr("name");
          var sortorder = $("#sort .fa-sort-up").length ? "ASC" : "DESC";

          return {
            status: status,
            skills: skills,
            search: search,
            sortby: sortby,
            sortorder: sortorder,
          };
        }

        $(document).on("keyup", "#search", function (e) {
          if (e.keyCode == 13) {
            e.preventDefault();
            loadjobs();
          }
        });
        $(document).on("change", "#status", function (e) {
          loadjobs();
        });
        $("#collapseExample .apply , #searchBtn").click(function (e) {
          e.preventDefault();
          loadjobs();
        });
        function loadjobs() {
          var filters = getFilters();
          console.log(filters);
          filters.skills = JSON.stringify(filters.skills);
          $.ajax({
            type: "POST",
            url: "/api/jobs",
            data: filters,
            success: function (res) {
              console.table(res);
              // showJobs(res);
            },
            error: function (error) {
              console.log(error);
            },
          });
        }
      });
    </script>
  </body>
</html>
