{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SkilNexus</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="{%  static 'css/style.css' %}" />
  </head>

  <body>
    <div aria-live="polite" aria-atomic="true" class="position-relative">
      <div class="toast-container top-0 end-0 p-3">
        <!-- Then put toasts within -->
      </div>
    </div>
    {% include "sidebar.php" %}

    <div class="my-round" id="body">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mybg-t breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/" class="my-color">Home</a></li>
          <li class="breadcrumb-item">
            <a href="/profile" class="my-color">Profile</a>
          </li>
          <li class="breadcrumb-item active my-color" aria-current="page">
            Jobs
          </li>
        </ol>
      </nav>
      <!-- Program Print Section -->

      <!-- Modal -->
      <div
        class="modal fade modal-lg"
        id="addJobModal"
        tabindex="-1"
        aria-labelledby="programSessionModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <form id="addJobForm">
              <div class="modal-header">
                <h5 class="modal-title" id="">Offer New Job</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body row">
                <div class="col-12 form-group mb-2">
                  <label for="title">Job Title:</label>
                  <input
                    type="text"
                    class="form-control"
                    name="title"
                    maxlength="255"
                    required
                  />
                </div>
                <div class="col-12 form-group mb-2">
                  <label for="description">Job Description:</label>
                  <textarea
                    class="form-control"
                    name="description"
                    rows="4"
                    required
                  ></textarea>
                </div>
                <div class="col-12 form-group mb-2">
                  <label for="skill">Required Skills:</label>
                  <select multiple class="form-control" name="skill">
                    {% for skill in skills %}
                    <option value="{{skill.id}}">{{skill.name}}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group d-none">
                  <label for="location">Location:</label>
                  <input
                    type="text"
                    class="form-control"
                    name="location"
                    maxlength="255"
                    value="Remote"
                  />
                </div>
                <div class="col-xl-4 form-group mb-2">
                  <label for="project_duration">Project Duration:</label>
                  <input
                    type="text"
                    class="form-control"
                    name="project_duration"
                    maxlength="255"
                    required
                  />
                </div>
                <div class="col-xl-4 form-group mb-2">
                  <label for="price">Price:</label>
                  <input
                    type="number"
                    class="form-control"
                    name="price"
                    step="0.01"
                    required
                  />
                </div>
                <div class="col-xl-4 form-group mb-2">
                  <label for="deadline">Deadline: {% now "Y-m-d" %}</label>
                  <input
                    type="date"
                    class="form-control"
                    name="deadline"
                    min='{% now "Y-m-d" %}'
                    required
                  />
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
                <button type="submit" class="btn btn-primary save">
                  Save changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Program Overview Section -->
      <div class="row">
        <div class="col-12">
          <div class="card my-row rounded-0 mybg">
            <div class="card-header" style="margin: -10px -10px 0 -10px">
              <div class="d-flex justify-content-between">
                <h3 class="card-title mb-0">My Jobs</h3>
                <button
                  class="btn btn-primary ms-2 rounded-0"
                  data-bs-toggle="modal"
                  data-bs-target="#addJobModal"
                >
                  Offer New Job
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="tableSearch"
                  placeholder="Search Jobs..."
                />
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Location</th>
                      <th>Project Duration</th>
                      <th>Price</th>
                      <th>Deadline</th>
                      <th>Skills</th>
                      <th>Offer Count</th>
                      <th>Created At</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="jobs">
                    {% for job in jobs %}
                    <tr>
                      <td>
                        <a
                          class="text-decoration-none"
                          href="/employer/job/{{ job.id }}"
                          >{{ job.title }}</a
                        >
                      </td>
                      <td>{{ job.location }}</td>
                      <td>{{ job.project_duration }}</td>
                      <td>{{ job.price }}</td>
                      <td>{{ job.deadline |date:"M d, Y, h:i A" }}</td>
                      <td>{{ job.skills }}</td>
                      <td>{{ job.offer_count }}</td>
                      <td>{{ job.created_at|date:"M d, Y, h:i A" }}</td>
                      <td>
                        {% if job.status == 'open' %}
                        <span class="badge bg-info">Open</span>
                        {% elif job.status == 'in_progress' %}
                        <span class="badge bg-primary">In Progress</span>
                        {% elif job.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                        {% elif job.status == 'cancelled' %}
                        <span class="badge bg-danger">Cancelled</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ job.status }}</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'js/script.js' %}"></script>
    <script>
      $(document).ready(function () {
        on_page_load([]);
        // Search functionality
        $("#tableSearch").on("input", function () {
          var searchQuery = $(this).val().toLowerCase();
          $(".table tbody tr").each(function () {
            var rowText = $(this).text().toLowerCase();
            $(this).toggle(rowText.includes(searchQuery));
          });
        });
        // save new job
        $("#addJobModal .modal-footer button.save").on("click", function (e) {
          e.preventDefault();
          let data = collectData("#addJobModal .form-control");
          data.skill = JSON.stringify(data.skill);
          $.ajax({
            type: "post",
            url: "/api/employer/job/new",
            data: data,
            success: function (res) {
              $("#addJobModal .form-control:not(.d-none)").val("");
              $("#addJobModal").modal("hide");
              showToast("Job added successfully", "success");
              $("#jobs").append(`
                <tr>
                  <td><a class="text-decoration-none" href="/employer/job/${
                    res.id
                  }">${res.title}</a></td>
                  <td>${res.location}</td>
                  <td>${res.project_duration}</td>
                  <td>${res.price}</td>
                  <td>${formatDateTime(res.deadline)}</td>
                  <td>${res.skills}</td>
                  <td>${res.offer_count}</td>
                  <td>${formatDateTime(res.created_at)}</td>
                  <td><span class="badge bg-info">Open</span></td>
                </tr>
              `);
            },
            error: function (xhr, status, error) {
              if (xhr.responseJSON) {
                labelErrors("#addJobModal .form-control", xhr.responseJSON); // display error messages
              }
              showToast("Error adding job", "danger");
            },
          });
        });
      });
    </script>
  </body>
</html>
