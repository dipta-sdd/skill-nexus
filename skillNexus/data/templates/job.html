{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkilNexus</title>
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{%  static 'css/style.css' %}" />
</head>

<body>
  <div aria-live="polite" aria-atomic="true" class="position-relative">
    <div class="toast-container top-0 end-0 p-3">
      <!-- Then put toasts within -->
    </div>
  </div>
  {% include "sidebar.php" %}

  <div class="my-round" id="body">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mybg-t breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/" class="my-color">Home</a></li>
        <li class="breadcrumb-item"><a href="/jobs" class="my-color">Jobs</a></li>
        <li class="breadcrumb-item active my-color" aria-current="page">{{job.title}}</li>
      </ol>
    </nav>
    <!-- Program Print Section -->


    <!-- Modal -->
   
    <!--  Overview Section -->
    <div class="row ">
      <div class="col-lg-12 border-0">
        <div class="card my-row rounded-0 mybg border-0">
          <div class="card-header" style="margin: -10px -10px 0 -10px">
            <div class="d-flex justify-content-between" id="headingOne">
              <h3 class="card-title mb-0">{{ job.title }}</h3>
              {% if user.is_authenticated and user.role != 'Employer' and job.status == 'open' and not job.applied_status %}
                <a href="#collapseOne" data-bs-toggle="collapse" class="btn btn-primary">Apply for Job</a> 
              {% elif user.is_authenticated and user.role != 'Employer' and job.applied_status %}
                {% if job.applied_status == 'Pending' %}
                  <span class="badge bg-info" style="height: max-content;">Pending</span>
                {% elif job.applied_status == 'Accepted' %}
                  <span class="badge bg-success" style="height: max-content;">Accepted</span>
                {% elif job.applied_status == 'Rejected' %}
                  <span class="badge bg-danger" style="height: max-content;">Rejected</span>
                {% endif %}
                
              {% endif %}
            </div>
            <div class="d-flex justify-content-between mt-2">
              <p class="text-muted mb-0">Posted by: {{ job.employer }} </p>
              <small class="text-muted mb-0"><i>Posted on: {{ job.created_at|date:"M d, Y, h:i A" }} </i></small>
            </div>
          </div>
          <div class="card-body m-0 p-0 bg-transparent">
            <div class="row mt-2">
              <div class="col-12"><p><strong>Description:</strong> {{ job.description }}</p></div>
              <div class="col-md-8">
                
                <p><strong>Skills:</strong> {{ job.skills }}</p>
                <p><strong>Project Duration:</strong> {{ job.project_duration }}</p>
                <span class="badge rounded-pill {% if job.status == 'open' %}bg-primary{% elif job.status == 'in_progress' %}bg-info{% elif job.status == 'completed' %}bg-success{% elif job.status == 'cancelled' %}bg-danger{% endif %} text-capitalize"><strong>Status:</strong> {{ job.status }}</span>
              </div>
              <div class="col-md-4">
                <p><strong>Price:</strong> ${{ job.price }}</p>
                <p><strong>Deadline:</strong> {{ job.deadline|date:"M d, Y" }}</p>
                <p><strong>Location:</strong> {{ job.location }}</p>
              </div>
            </div> 
            {% if user.is_authenticated %}
              <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#jobDetailsAccordion"></div>
            {% elif job.applied_status %}
              <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#jobDetailsAccordion"></div>
            {% endif %}
            
              <div class="accordion-body">
                <!-- apply form here -->
                <div class="row">
                  <div class="mb-3 col-lg-6">
                    <label for="proposed_rate" class="form-label">Proposed Rate</label>
                    <input type="number" class="form-control" name="proposed_rate" id="proposed_rate" step="0.01" value="{{job.proposed_rate}}" required {% if job.applied_status and job.applied_status != 'Pending' %} readonly {% endif %}>
                  </div>
                  <div class="mb-3 col-lg-6">
                    <label for="proposed_deadline" class="form-label">Proposed Deadline</label>
                    <input type="date" class="form-control" name="proposed_deadline" id="proposed_deadline" 
                    value="{% if job.proposed_deadline %}{{job.proposed_deadline|date:'Y-m-d'}}{% else %}{{ job.deadline|date:'Y-m-d' }}{% endif %}" required {% if job.applied_status and job.applied_status != 'Pending' %} readonly {% endif %}>
                  </div>
                  <div class="mb-3 col-12">
                    <label for="proposal" class="form-label">Proposal</label>
                    <textarea class="form-control" name="proposal" id="proposal" rows="3" required {% if job.applied_status and job.applied_status != 'Pending' %} readonly {% endif %}>{{job.proposal|default_if_none:""}}</textarea>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary" id="apply-btn" data-id="{{job.id}}" data-employer="{{job.employer_id}}" data-offer-id="{{job.offer_id|default_if_none:''}}" {% if job.applied_status and job.applied_status != 'Pending' %} disabled {% endif %}>{% if job.applied_status %} Update Offer {% else %} Apply {% endif %}</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>




  </div>
  </div>

 
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

  <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'js/script.js' %}"></script>
  <script src="{% static 'js/manageProgram.js' %}"></script>
  <script>
    $(document).ready(function () {
      on_page_load([]);
      // apply
      $('#apply-btn').click(function (e) {
        e.preventDefault();
        let data = {
            proposed_rate: $('#proposed_rate').val(),
            proposed_deadline: $('#proposed_deadline').val(),
            proposal: $('#proposal').val(),
            employer: $(this).attr('data-employer')
          }
        if ($(this).attr('data-offer-id'))
          data['id'] = $(this).attr('data-offer-id');
        $.ajax({
          type: "post",
          url: "/api/job/"+$(this).attr('data-id')+"/apply",
          data: data,
          success: function (response) {
            showToast("Application submitted successfully!", "primary");
            $('#apply-btn').text('Update Offer');
            $('#apply-btn').attr('data-offer-id', response.id);
            $('#headingOne a').addClass('d-none');
            $('#headingOne span').addClass('d-none');
            $('#headingOne').append(`
              <span class="badge bg-info" style="height: max-content;">Pending</span>
            `)
          },
          error: function (xhr, status, error) {
            if (xhr.responseJSON) {
              labelErrors("#collapseOne .form-control", xhr.responseJSON);
            }
            showToast("Application submission failed!", "danger");
          }
        }); 
      }); // end apply 
    });
  </script>

</body>

</html>